groups:
- name: thanos-querier.rules
  rules:
  - expr: |
      sum(
        rate(grpc_client_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss", job="thanos-querier", grpc_type="unary"}[5m])
        /
        rate(grpc_client_started_total{job="thanos-querier", grpc_type="unary"}[5m])
      )
    labels: {}
    record: thanos_querier:grpc_client_failures_per_unary:rate5m
  - expr: |
      sum(
        rate(grpc_client_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss", job="thanos-querier", grpc_type="server_stream"}[5m])
      /
        rate(grpc_client_started_total{job="thanos-querier", grpc_type="server_stream"}[5m])
      )
    labels: {}
    record: thanos_querier:grpc_client_failures_per_stream:rate5m
  - expr: |
      sum(
        rate(thanos_querier_store_apis_dns_failures_total{job="thanos-querier"}[5m])
      /
        rate(thanos_querier_store_apis_dns_lookups_total{job="thanos-querier"}[5m])
      )
    labels: {}
    record: thanos_querier:store_apis_dns_failures_per_lookup:rate5m
  - expr: |
      histogram_quantile(0.99,
        sum(thanos_query_api_instant_query_duration_seconds_bucket{job="thanos-querier"}) by (le)
      )
    labels: {}
    record: thanos_querier:api_instant_query_duration_seconds:p99:sum
  - expr: |
      histogram_quantile(0.99,
        sum(rate(thanos_query_api_instant_query_duration_seconds_bucket{job="thanos-querier"}[5m])) by (le)
      )
    labels: {}
    record: thanos_querier:api_instant_query_duration_seconds:p99:rate5m
  - expr: |
      histogram_quantile(0.99,
        sum(thanos_query_api_range_query_duration_seconds_bucket{job="thanos-querier"}) by (le)
      )
    labels: {}
    record: thanos_querier:api_range_query_duration_seconds:p99:sum
  - expr: |
      histogram_quantile(0.99,
        sum(rate(thanos_query_api_range_query_duration_seconds_bucket{job="thanos-querier"}[5m])) by (le)
      )
    labels: {}
    record: thanos_querier:api_range_query_duration_seconds:p99:rate5m
- name: thanos-receive.rules
  rules:
  - expr: |
      sum(
        rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss", job="thanos-querier", grpc_type="unary"}[5m])
      /
        rate(grpc_server_started_total{job="thanos-querier", grpc_type="unary"}[5m])
      )
    labels: {}
    record: thanos_receive:grpc_server_failures_per_unary:rate5m
  - expr: |
      sum(
        rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss", job="thanos-querier", grpc_type="server_stream"}[5m])
      /
        rate(grpc_server_started_total{job="thanos-querier", grpc_type="server_stream"}[5m])
      )
    labels: {}
    record: thanos_receive:grpc_server_failures_per_stream:rate5m
  - expr: |
      sum(
        rate(thanos_http_requests_total{job="thanos-receive", code!~"2.."}[5m])
      /
        rate(thanos_http_requests_total{job="thanos-receive"}[5m])
      )
    labels: {}
    record: thanos_receive:http_failure_per_request:rate5m
  - expr: |
      histogram_quantile(0.99,
        sum(thanos_http_request_duration_seconds_bucket{job="thanos-receive"}) by (le)
      )
    labels: {}
    record: thanos_receive:http_request_duration_seconds:p99:sum
  - expr: |
      histogram_quantile(0.99,
        sum(rate(thanos_http_request_duration_seconds_bucket{job="thanos-receive"}[5m])) by (le)
      )
    labels: {}
    record: thanos_receive:http_request_duration_seconds:p99:rate5m
  - expr: |
      sum(
        rate(thanos_receive_forward_requests_total{result="error", job="thanos-receive"}[5m])
      /
        rate(thanos_receive_forward_requests_total{job="thanos-receive"}[5m])
      )
    labels: {}
    record: thanos_receive:forward_failure_per_requests:rate5m
  - expr: |
      sum(
        rate(thanos_receive_hashrings_file_errors_total{job="thanos-receive"}[5m])
      /
        rate(thanos_receive_hashrings_file_refreshes_total{job="thanos-receive"}[5m])
      )
    labels: {}
    record: thanos_receive:hashring_file_failure_per_refresh:rate5m
- name: thanos-store.rules
  rules:
  - expr: |
      sum(
        rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss", job="thanos-store", grpc_type="unary"}[5m])
      /
        rate(grpc_server_started_total{job="thanos-store", grpc_type="unary"}[5m])
      )
    labels: {}
    record: thanos_store:grpc_server_failures_per_unary:rate5m
  - expr: |
      sum(
        rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss", job="thanos-store", grpc_type="server_stream"}[5m])
      /
        rate(grpc_server_started_total{job="thanos-store", grpc_type="server_stream"}[5m])
      )
    labels: {}
    record: thanos_store:grpc_server_failures_per_stream:rate5m
  - expr: |
      sum(
        rate(thanos_objstore_bucket_operation_failures_total{job="thanos-store"}[5m])
      /
        rate(thanos_objstore_bucket_operations_total{job="thanos-store"}[5m])
      )
    labels: {}
    record: thanos_store:objstore_bucket_failures_per_operation:rate5m
  - expr: |
      histogram_quantile(0.99,
        sum(thanos_objstore_bucket_operation_duration_seconds_bucket{job="thanos-store"}) by (le)
      )
    labels: {}
    record: thanos_store:objstore_bucket_operation_duration_seconds:p99:sum
  - expr: |
      histogram_quantile(0.99,
        sum(rate(thanos_objstore_bucket_operation_duration_seconds_bucket{job="thanos-store"}[5m])) by (le)
      )
    labels: {}
    record: thanos_store:objstore_bucket_operation_duration_seconds:p99:rate5m
